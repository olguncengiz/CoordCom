/* Copyright (c) Ericsson 2016 */

define("chartlib/charts/_base/Chart",["jscore/core","chartlib/base/d3","chartlib/charts/Title","chartlib/charts/Grid","chartlib/charts/Legend"],function(t,e,i,n,r){"use strict";function a(t){if(this.options.legend!==!1&&t&&"toggle"===t.type){var e=this.legend.getLegendData().filter(function(t){return t.visible!==!1}).length,i=e+(t.entry.visible!==!1?-1:1);i>0&&(this.toggleEntryVisibility(t.entry,t.index),this.redraw())}}function o(t,e){var i="";return e.forEach(function(e){var n="";if(Array.isArray(e.data))if("title"===t){var r=e.label.toString();r.length>n.length&&(n=r)}else e.data.forEach(function(e){var i=e[t].toString();i.length>n.length&&(n=i)});else(e[t]||0===e[t])&&(n=e[t].toString());n.length>i.length&&(i=n)}),i}function s(){function i(i,n,r){var a,o=this.view.getTooltip(),s=o.find(".tooltipContent"),l=r.call(this,i,n),h=s.getText()!==l,d=this.getElement().getPosition(),c={height:t.Window.getProperty("innerHeight"),width:t.Window.getProperty("innerWidth")};h&&s.setText(l),o.setStyle({display:"block"}),a={height:o.getProperty("offsetHeight"),width:o.getProperty("offsetWidth")};var g=n[0]+15,f=n[1]-a.height-15;d.left+g+a.width+15>c.width&&(g=n[0]-15-a.width),e.event.clientY-a.height-15-45<0&&(f=n[1]+15),o.setStyle({top:f,left:g,opacity:1})}function n(){this.view.getTooltip().setStyle({display:"none"})}if(this.options.tooltip||this.options.legend.tooltip){var r=this.getD3Element(),a=this,o=this.getTooltipContent,s=this.getLegendTooltipContent,l=function(t){return-1!==t.attr("class").indexOf("datapoint")},h=function(t){return-1!==t.attr("class").indexOf("legendItem")},d=function(t){var n,d=e.mouse(r[0][0]),c=e.select(this);if(l(c))c.attr("stroke",e.rgb(c.attr("fill")).darker(1.2)).attr("stroke-width",2),n=o;else if(h(c)){if("function"!=typeof s)throw Error("Legend tooltip format function option required.");n=s}i.call(a,t,d,n)},c=function(){var t=e.select(this);l(t)&&t.attr("stroke-width",0),n.call(a)};if(this.options.tooltip&&r.selectAll(".hoverable").on("mousemove",d).on("mouseout",c),this.options.legend.tooltip){var g=this.getEventBus(),f=function(t){d.call(t.context,t.entry,t.index)},p=function(t){c.call(t.context,t.entry,t.index)};g.subscribe("legend:mousemove",f),g.subscribe("legend:mouseout",p)}}}function l(){return'<div><svg width="100%" height="100%"></svg></div>'}function h(){return'<div class="tooltip"><div class="tooltipContent"></div></div>'}function d(){var t=this.getD3Element(),i=function(t){return function(i){void 0!==this.cleanEventData&&(i=this.cleanEventData(i)),this.trigger(t,i,{stopPropagation:e.event.stopPropagation.bind(e.event),preventDefault:e.event.preventDefault.bind(e.event),originalEvent:e.event})}.bind(this)};t.selectAll(".datapoint.clickable").on("click",i.call(this,"entry:click")).on("contextmenu",i.call(this,"entry:contextmenu")).on("mouseenter",i.call(this,"entry:mouseenter")).on("mouseleave",i.call(this,"entry:mouseleave"))}return t.Widget.extend({baseWidth:750,baseHeight:422,defaults:{},coreDefaults:{theme:{font:{fontFamily:"Arial, sans-serif",fontSize:"12px"},colors:["#89ba17","#00a9d4","#7b0663","#00625f","#fabb00","#f08a00","#e32119","#b8d674","#99ddee","#ca9bc1","#99c0bf","#fde499","#f9d099","#f4a6a3"],container:{fill:"#fff",fillOpacity:1,stroke:"#fff",strokeWidth:0},title:{fontWeight:"normal",fontFamily:"Arial",fontSize:21,fill:"#58585b"},subTitle:{fontWeight:"normal",fontSize:14,fontFamily:"Arial",fill:"#58585b"},plotOptions:{},legend:{text:{fill:"#58585b",fontSize:"12px"}},tooltip:{position:"absolute",display:"none","z-index":1,"max-width":"50%","overflow-x":"hidden",opacity:0,margin:0,padding:"6px",color:"#666",border:"1px solid #999","border-radius":"3px","box-shadow":"0px 1px 3px rgba(0, 0, 0, 0.2)",background:"#ffffff","text-align":"center","pointer-events":"none","word-wrap":"break-word"},grid:{text:{fill:"#58585b"},axis:{fill:"#b0b2b3"},stroke:{fill:"#b0b2b3",dashArray:"1,3"}}},chart:{margin:{top:20,right:20,bottom:20,left:20},decimals:0,decimalSeparator:".",scale:!1,zeroBaseline:!0},animation:{transitionDuration:750,transitionDelay:0,easing:"cubic-in-out"},plotOptions:{},legend:!1,tooltip:!1,title:!1,subTitle:!1,grid:!0},View:t.View.extend({getTemplate:function(){return l()},getTooltip:function(){return this.getElement().find(".tooltip")}}),init:function(){this.id=this.generateUUID(),this._eventBus=new t.EventBus,this._eventBus.subscribe("legend:click",a.bind(this));var i=JSON.parse(JSON.stringify(this.coreDefaults)),n=JSON.parse(JSON.stringify(this.defaults));n=this.objectMerger(i,n),this.options=this.objectMerger(n,this.options);var r=this.options.theme.colors;this.colorScale=Array.isArray(r)?e.scale.ordinal().range(this.options.theme.colors):r,Array.isArray(r)&&Array.isArray(this.options.data)&&this.colorScale.domain(this.options.data.map(function(t){return t.label})),this.chartSize={width:this.baseWidth,height:this.baseHeight,margins:{left:20,top:20}},this.scaleHelper={},this.toggledEntry={},this.firstRun=!0,this.createPrivateVariables()},makeGradientAverage:function(t,e,i){function n(t,e){return t+Math.round((e-t)*(i/100))}function r(t){t=Math.min(t,255),t=Math.max(t,0);var e=t.toString(16);return e.length<2&&(e="0"+e),e}var a={},o=/(.*?)rgb\((\d+), (\d+), (\d+)\)/.exec(t),s=/(.*?)rgb\((\d+), (\d+), (\d+)\)/.exec(e);return a.r=n(parseInt(o[2]),parseInt(s[2])),a.g=n(parseInt(o[3]),parseInt(o[3])),a.b=n(parseInt(o[4]),parseInt(o[4])),a.cssColor="#"+r(a.r)+r(a.g)+r(a.b),"rgb("+a.r+","+a.g+","+a.b+")"},update:function(t){Array.isArray(t)&&this.patchDataEntryVisibility(t),this.onUpdate(t),s.call(this),d.call(this),this.firstRun=!1},onUpdate:function(){},redraw:function(){throw new Error("redraw() method must be implemented")},onViewReady:function(){if(this.resizeEvent=t.Window.addEventHandler("resize",function(){this.resize()}.bind(this)),void 0!==this.options.tooltip||void 0!==this.options.legend.tooltip){var e=this.getElement(),i=t.Element.parse(h());i.setStyle(this.options.theme.tooltip),e.setStyle({position:"relative"}),e.append(i)}this._width=this.options.width,this._height=this.options.height,this.onChartReady(this.options)},onChartReady:function(){},onDOMAttach:function(){this._attachedToDOM=!0,this.svg=this.getD3Element(),void 0===this.defs&&(this.defs=this.svg.append("defs")),this.svg.style("font",this.options.theme.font.fontSize+" "+this.options.theme.font.fontFamily),this.drawBackground(),this.options.title!==!1&&(this.title=new i(this.options,this)),this.options.grid&&void 0===this.grid&&(this.grid=new n(this.options,this)),this.options.legend!==!1&&void 0===this.legend&&(this.legend=new r(this.options,this)),this.resize(),requestAnimationFrame(function(){this.trigger("domattach")}.bind(this))},onDestroy:function(){t.Window.removeEventHandler(this.resizeEvent)},getD3Element:function(){return this._svg||(this._svg=this.getElement().find("svg")._getHTMLElement()),e.select(this._svg)},getSize:function(){return{width:this.getElement().getProperty("offsetWidth"),height:this.getElement().getProperty("offsetHeight")}},resize:function(t,e){void 0!==t&&(this._width=t),void 0!==e&&(this._height=e),this.getElement().setStyle({width:this._width||"100%",height:this._height||"100%"});var i=this.getSize();if(0!==i.width&&0!==i.height){var n=this._previousSize;void 0!==n&&n.width===i.width&&n.height===i.height||!this._attachedToDOM||(this.redraw(),this._previousSize=i)}},generateUUID:function(){var t=Date.now(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:7&i|8).toString(16)});return e},createSVGElement:function(){return l()},drawBackground:function(){var t=this.options;if(t.theme.container.fill){if(void 0!==this.backgroundWrapper)return;if(this.backgroundWrapper=this.svg.append("rect").attr("id","backgroundWrapper-"+this.id),this.backgroundWrapper.attr("width","100%").attr("height","100%"),t.theme.container.fill.linearGradient){var e=this.defs.append("linearGradient").attr("id","dv-backgroundgradient"+this.id).attr("x1",t.theme.container.fill.linearGradient.x1).attr("y1",t.theme.container.fill.linearGradient.y1).attr("x2",t.theme.container.fill.linearGradient.x2).attr("y2",t.theme.container.fill.linearGradient.y2);e.append("stop").attr("offset","0").attr("stop-opacity","1").attr("stop-color",t.theme.container.fill.stops[0]),e.append("stop").attr("offset","1").attr("stop-opacity","1").attr("stop-color",t.theme.container.fill.stops[1]),this.backgroundWrapper.attr("fill","url(#dv-backgroundgradient"+this.id+")"),this.backgroundType="gradient"}else this.backgroundWrapper.attr("fill",t.theme.container.fill).attr("fill-opacity",t.theme.container.fillOpacity),this.backgroundType="flat",("#ffffff"===t.theme.container.fill||"#fff"===t.theme.container.fill)&&(this.backgroundType="white"),0===parseFloat(t.theme.container.fillOpacity)&&(this.backgroundType="transparent");this.backgroundWrapper.attr("stroke",t.theme.container.stroke).attr("stroke-width",t.theme.container.strokeWidth)}},roundToDecimals:function(t,e,i){var n,r=1;return e?(r=Math.pow(10,e),n=e):(r=Math.pow(10,this.options.chart.decimals),n=this.options.chart.decimals),t=Math.round(t*r),t/=r,i===!0&&(t=t.toFixed(n)),t=t.toString().replace(".",this.options.chart.decimalSeparator)},objectMerger:function(t,e){if(t&&e){var i,n={};Array.isArray(t)&&(n=[]);for(i in e)t.hasOwnProperty(i)&&e.hasOwnProperty(i)?n[i]="object"==typeof t[i]&&"object"==typeof e[i]?this.objectMerger(t[i],e[i]):e[i]:e.hasOwnProperty(i)&&(n[i]=e[i]);for(i in t)i in e||!t.hasOwnProperty(i)||(n[i]=t[i]);return n}return null},addIDsToData:function(t){var e={};return this.options.plotOptions.scaleType&&"ordinal"!==this.options.plotOptions.scaleType.x?t:(t.forEach(function(t){if(e[t.label]?e[t.label]+="*":e[t.label]=" "," "!==e[t.label]&&(t.label=t.label+e[t.label]),t.data){var i={};t.data.forEach(function(t){i[t.label]?i[t.label]+="*":i[t.label]=" "," "!==i[t.label]&&(t.label=t.label+i[t.label])})}}),t)},changeSizeForDataLabels:function(){},changeSizeForGrid:function(t,e){if(!this.grid)return t;var i,n=this.options,r="horizontal"===n.plotOptions.orientation,a=r?"x":"y",o=this.grid.getOptions().tickSize[a];if(n.grid.tickSize&&n.grid.tickSize[a])i=o;else{var s=r?this.getLongestLabelFromData(e):this.getLongestValueFromData(e),l="x"===a?this.grid.getEntriesAxisFormat():this.grid.getValuesAxisFormat();n.chart.scale&&n.chart.scale.y&&(s=n.chart.scale.y.max.toString().length>n.chart.scale.y.min.toString().length?n.chart.scale.y.max:n.chart.scale.y.min),s=this.localizeValueString(s,l),i=this.measureTextFieldSize(s),i.width+=10,i.height+=6,o.width=i.width,o.height=i.height}this.grid.yAxisSize!==!1&&(i={height:i.height,width:this.grid.yAxisSize});var h=Math.ceil(i.width),d=Math.ceil(i.height);if(t.margins.left+=h,t.width-=h,t.height-=d+5,n.grid.axisLabels){var c=this.grid.getEntriesAxisLabelSize(),g=this.grid.getValuesAxisLabelSize(),f=void 0!==c?Math.round(c.height):0,p=void 0!==g?Math.round(g.height):0;r?(t.height-=p,f>0&&(t.width-=f+10,t.margins.left+=f+10)):(t.height-=f,p>0&&(t.width-=p+15,t.margins.left+=p+15))}return t},changeSizeForTitle:function(t){var e=this.options;if(e.title){var i=this.title.getTitleSize();t.margins.top+=i.height+10,t.height-=i.height+10}return t},changeSizeForLegend:function(t,e){var i=this.options;if(i.legend!==!1){var n=this.getLongestLabelFromData(e),r=this.measureTextFieldSize(n);if("bottom"===this.legend.align){var a=this.legend.createLegendItems(e);this.legend.positionLegendItemsAtBottom(a,t),r=this.legend.legendWrapper.node().getBBox(),t.height-=Math.ceil(r.height)+10}else"right"===this.legend.align&&(t.width-=Math.ceil(r.width)+2*this.legend.circleRadius+this.legend.circleDistance+10)}return t},measureTextFieldSize:function(t,e,i){var n=this.options,r=this.svg.append("g"),a=e?e:n.theme.font.fontSize,o=i?i:n.theme.font.fontFamily;return r.attr("transform","translate(-1000,-1000)"),r.append("text").attr("font-size",a).attr("font-family",o).text(t),setTimeout(function(){r.remove()},10),r.node().getBBox()},localizeValueString:function(t,e){function i(t){return Math.round(t).toString().replace(/./g,function(t,e,i){return!e||"."===t||(i.length-e)%3?t:","+t})}return void 0!==e?e(t):i(t)},getLongestValueFromData:function(t){return this.getLongestStringFromData("value",t)||"0"},getLongestLabelFromData:function(t){return this.getLongestStringFromData("label",t)},getLongestStringFromData:function(t,e){var i="";return e.forEach(function(e){var n="";Array.isArray(e.data)?e.data.forEach(function(e){var i=e[t],r="label"===t?i:Math.round(1>i?1e3*i:i),a=r.toString();a.length>n.length&&(n=a)}):(e[t]||0===e[t])&&(n=e[t].toString()),n.length>i.length&&(i=n)}),i},getLongestTitleFromData:function(t){return o("title",t)},wrapTextField:function(t,e,i,n,r,a){for(var o,s=e.split(/\s+/).reverse(),l=[],h=1,d=s.pop(),c=this.svg.append("text").attr("font-family",t.attr("font-family")).attr("font-size",t.attr("font-size")).attr("x",-1e3).attr("y",-1e3),g=t.append("tspan").attr("x",i);d&&(l.push(d),o=l.join(" "),c.text(o),g.text(o),h!==a);)c.node().getBBox().width>n&&(l.pop(),g.text(l.join(" ")),l=[d],g=t.append("tspan").attr("x",i).attr("dy",r+"em"),h++),d=s.pop();c.remove()},wrapTextEllipsis:function(t,i,n,r){t.each(function(t,a){var o=e.select(this),s=o.selectAll("text");if(!s.empty()){var l,h=o.selectAll(".wrappedText"),d=o.selectAll(".wrappingFobj"),c=s.node().getBBox();if(d.empty()&&(d=o.append("foreignObject").attr("class","wrappingFobj"),h=d.append("xhtml:p").attr("class","wrappedText")),void 0!==i&&d.attr("width",Math.max(0,i.width||Math.ceil(c.width))).attr("height",Math.max(0,i.height||Math.ceil(c.height))),void 0!==n){var g=n[a]||{x:c.x,y:c.y};d.attr("x",-g.x).attr("y",g.y)}l=s.text(),s.style("opacity",0),r&&r.title===!1||h.attr("title",l),h.text(l)}})},createPrivateVariables:function(){},toggleEntryVisibility:function(t){t.visible=void 0!==t.visible?!t.visible:!1;var e=this.toggledEntry[t.label];(void 0===e||e!==t.visible)&&(this.toggledEntry[t.label]=t.visible)},patchDataEntryVisibility:function(t){var e=this.firstRun,i=this.toggledEntry;if(!e&&0===Object.keys(i).length)return t;var n=function(t){return Array.isArray(t)?t.map(n):(e&&t.visible===!1?i[t.label]=t.visible:void 0!==i[t.label]&&(t.visible=i[t.label]),void(void 0!==t.data&&t.data.forEach(n)))};return t.map(n)},getEventBus:function(){return this._eventBus},getTooltipContent:function(t){void 0!==this.cleanEventData&&(t=this.cleanEventData(t));var e=this.options.tooltip,i="function"==typeof e.format?e.format:function(t){return t.label+" : "+("number"==typeof t.value?Math.round(100*t.value)/100:t.value.toString())};return i.call(this,t)},getLegendTooltipContent:function(t){var e=this.options.legend.tooltip,i=e&&"function"==typeof e.format?e.format:function(t){return t.label};return i.call(this,t)}})}),define("chartlib/charts/Chart",["chartlib/charts/_base/Chart"],function(t){return t});