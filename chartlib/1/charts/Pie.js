/* Copyright (c) Ericsson 2016 */

define("chartlib/charts/Pie",["chartlib/base/d3","chartlib/charts/Chart"],function(t,i){"use strict";function e(t){return this.isGradientFill?"url(#piegradientfill-"+this.id+")":this.colorScale(t.data.label,t)}function n(t){var i=this.options,n=this;t.selection.enter().append("path").attr("opacity",t.opacity).attr("class","arc clickable hoverable datapoint").each(function(i){isNaN(i.startAngle)&&(i.startAngle=0),isNaN(i.endAngle)&&(i.endAngle=0),this._current=i,i.arcHelper=t.arcHelper}).attr("d",function(i,e,a){return t.arcHelper(i,e,a,this,n)}).attr("fill",e.bind(this)).transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attrTween("d",function(t,i,e){return r(t,i,e,this,n)}),t.selection.exit().remove()}function a(t){var i=this.options,n=this;t.selection.each(function(i){isNaN(i.startAngle)&&(i.startAngle=0),isNaN(i.endAngle)&&(i.endAngle=0),i.arcHelper=t.arcHelper}).transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attr("fill",e.bind(this)).attrTween("d",function(t,i,e){return r(t,i,e,this,n)})}function r(i,e,n,a,r){isNaN(a._current.endAngle)&&(a._current.endAngle=0,a._current.startAngle=0,i.endAngle=0,i.startAngle=0);var s=t.interpolate(a._current,i);return a._current=s(0),function(t){return i.arcHelper(s(t),e,n,a,r)}}function s(t){t.forEach(function(t){t.data.forEach(function(i){i.parentLabel=t.label})})}return i.extend({defaults:{theme:{plotOptions:{pie:{stroke:{color:"#ffffff",width:1},fill:!1,comparisonCallouts:{radius:3,strokeWidth:1,fill:"lightgrey"}}}},plotOptions:{pie:{radius:!1,innerRadius:!1}},legend:!1,grid:!1},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.pieLayers=[],this.radius=0,this.innerRadius=0,this.data=[],this.pieWrapper=[],this.gradientFill=[],this.calloutLegendFontSize=12,this.calloutLegendWrapper=null,this.dataDimensions=2,this.baseTextDistance=20,this.divingLinesStyle={color:"#ffffff",width:1},this.isGradientFill=!1,this.useCoreLegend=!0,this.useCallouts=!1,this.arcHelpers={}},redraw:function(){this.isGradientFill=this.options.theme.plotOptions.pie.fill!==!1,this.isGradientFill!==!1&&(this.useCoreLegend=!1),this.createGradientFill(),this.createWrapper(),this.update(this.options.data)},createWrapper:function(){0===this.pieWrapper.length&&(this.pieWrapper=this.svg.append("g").attr("id","pieWrapper-"+this.id))},createGradientFill:function(){if(this.isGradientFill===!0&&0===this.gradientFill.length){this.gradientFill=this.defs.append("linearGradient").attr("id","piegradientfill-"+this.id).attr("gradientUnits","userSpaceOnUse");var t=this.options.theme.plotOptions.pie.fill;this.options.theme.plotOptions.pie.fill.stops&&(t=this.options.theme.plotOptions.pie.fill.stops[0]);var i=this.options.theme.plotOptions.pie.fill;this.options.theme.plotOptions.pie.fill.stops&&(i=this.options.theme.plotOptions.pie.fill.stops[1]),this.gradientFill.append("stop").attr("offset","0").attr("stop-opacity","1").attr("stop-color",t),this.gradientFill.append("stop").attr("offset","1").attr("stop-opacity","1").attr("stop-color",i)}},updateGradientFill:function(){var t=this.radius;this.isGradientFill===!0&&this.gradientFill.attr("x1",-(t/2)).attr("y1",-(t/2)).attr("x2",t/2).attr("y2",t/2)},onUpdate:function(t){this.options.data=t,this.data=this.addIDsToData(t).filter(function(t){return t.visible!==!1});var i=this.options,e=this.chartSize,r=this.arcHelpers,o=this.data,l=t;l[0].data&&(l=l[0].data),o[0]&&(this.dataDimensions=o[0].data?3:2),this.dataDimensions>2&&s(o);var u=this.getSize();if(e.width=u.width-i.chart.margin.left-i.chart.margin.right,e.height=u.height-i.chart.margin.top-i.chart.margin.bottom,e.margins={left:i.chart.margin.left,top:i.chart.margin.top},e=this.changeSizeForTitle(e),this.useCoreLegend===!0&&(e=this.changeSizeForLegend(e,l)),this.figureOutRadius(),this.updateGradientFill(),this.createArcHelpers(),this.createAndPopulatePieLayers(),this.pieLayers.forEach(function(t){t.selection=t.wrapper.selectAll(".arc").data(r.pie(t.data)),a.call(this,t),n.call(this,t)}.bind(this)),this.useCallouts===!0){this.options.legend!==!1&&("callouts"===this.options.legend.align||this.isGradientFill!==!1)&&(this.calloutLegendWrapper||(this.calloutLegendWrapper=this.pieWrapper.append("g")));var p=2===this.dataDimensions?this.arcHelpers.pie(o):this.manipulateDataForMultidimensionalCalloutLegend(o),h=this.calloutLegendWrapper.selectAll("text").data(p);if(this.updateCallouts(h),this.createNewCallouts(h),3===this.dataDimensions){var c=this.calloutLegendWrapper.selectAll(".comparisonLine").data(this.figureOutComparisonLinesData(p));this.updateComparisonLines(c),this.createComparisonLines(c);var d=this.createComparisonDotSelection(o);this.updateComparisonDots(d),this.createComparisonDots(d)}}if(this.isGradientFill===!0||i.theme.plotOptions.pie.stroke!==!1){var g=this.createDividingLinesSelection(o);this.updateDividingLines(g),this.createDividingLines(g)}this.positionPie(),this.options.legend!==!1&&this.useCallouts!==!0&&this.legend.update(t,this.chartSize,this.scaleHelper)},figureOutRadius:function(){var t=this.options,i=this.chartSize,e=!1,n=!1;if(t.plotOptions&&t.plotOptions.pie&&(t.plotOptions.pie.radius&&(this.radius=t.plotOptions.pie.radius,this.innerRadius=.6*this.radius,e=!0,("callouts"===t.legend.align||this.isGradientFill===!0)&&(this.useCallouts=!0)),(t.plotOptions.pie.innerRadius||0===t.plotOptions.pie.innerRadius)&&(this.innerRadius=t.plotOptions.pie.innerRadius,n=!0)),e===!1){var a=i.height<i.width?i.height:i.width;this.radius=a/2,t.legend&&("callouts"===t.legend.align||this.isGradientFill===!0)&&(this.useCallouts=!0,a-=2.5*(this.calloutLegendFontSize+this.baseTextDistance),this.radius=a/2)}n===!1&&(this.innerRadius=0,3===this.dataDimensions&&(this.innerRadius=.5*this.radius)),e===!1&&n===!0&&(this.innerRadius=this.radius*t.plotOptions.pie.innerRadius)},createArcHelpers:function(){var i=this.arcHelpers,e=this.radius,n=this.innerRadius;i.arc=t.svg.arc().outerRadius(e).innerRadius(n),i.calloutArc=this.calloutArcFunction,i.pie=t.layout.pie().sort(null).value(function(t){return t.value})},createAndPopulatePieLayers:function(){for(var t=this.radius,i=this.innerRadius,e=this.pieLayers,n=this.data,a=this.PieLayer,r=this.dataDimensions,s=3===r?n.length:1,o=(t-i)/(s+1),l=0;s>l;l++){var u,p,h,c=3===r?n[l].data:n;3===r?(u=t-l*o,p=t-(l+1)*o,l===s-1&&(p-=o),h=1-.2*(s-1-l)):(u=t,p=i,h=1),e[l]?(e[l].radius=u,e[l].innerRadius=p,e[l].data=c,e[l].updateArcHelper()):e[l]=new a(c,{radius:u,innerRadius:p,opacity:h},this)}},positionPie:function(){var t=this.chartSize.margins.left+this.chartSize.width/2,i=this.chartSize.margins.top+this.chartSize.height/2;this.pieWrapper.attr("transform","translate("+t+","+i+")")},calloutArcFunction:function(t,i,e,n,a){var r=a.radius,s=a.arcHelpers,o=s.arc.apply(n,arguments),l=t,u=(l.startAngle+l.endAngle)/2,p=.08,h=Math.max(l.startAngle,l.endAngle),c=Math.min(l.startAngle,l.endAngle),d=h-c,g={y:Math.cos(u-p/2)*r,x:Math.sin(u-p/2)*r},f={y:Math.cos(u+p/2)*r,x:Math.sin(u+p/2)*r},m=a.measurePointDistance(g,f),v={y:Math.cos(u)*(r+m),x:Math.sin(u)*(r+m)};return d>p&&(o+=" M "+g.x+","+-1*g.y+" L "+v.x+","+-1*v.y+" L "+f.x+","+-1*f.y),o},measurePointDistance:function(t,i){var e=t.x-i.x,n=t.y-i.y,a=Math.pow(e,2)+Math.pow(n,2),r=Math.sqrt(a);return r},updateCallouts:function(t){var i=this.options,e=this;t.each(function(t){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0)}).transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attrTween("transform",function(t){return e.calloutLegendTween(t,this)})},createNewCallouts:function(i){var e=this.options,n=this,a=this.calloutLegendFontSize;i.enter().append("text").each(function(i){var e=t.select(this);if(i.data.label.length>10)if(-1!==i.data.label.indexOf(" ")){var n=i.data.label.split(" ");e.append("tspan").text(n[0]).attr("y",-(1.1*a)),e.append("tspan").text(n[1]).attr("x",0).attr("y",0)}else e.text(i.data.label.substr(0,9)+"...");else e.text(i.data.label)}).attr("font-size",a).attr("transform",function(t,i,e){return n.calloutLegendTranslate(t,i,e,n)}).attr("fill",e.theme.legend.text.fill).each(function(t){this.text=this,this._current=t}).transition().duration(e.animation.transitionDuration).delay(e.animation.transitionDelay).ease(e.animation.easing).attrTween("transform",function(t){return n.calloutLegendTween(t,this)}),i.exit().remove()},calloutLegendTween:function(i,e){var n=this;isNaN(e._current.endAngle)&&(e._current.endAngle=0,e._current.startAngle=0,i.endAngle=0,i.startAngle=0);var a=t.interpolate(e._current,i);e._current=a(0);var r=e.text;return function(t){return n.calloutLegendTranslate(a(t),0,0,n,r)}},calloutLegendTranslate:function(i,e,n,a,r){r=r||this;var s=a.radius,o=a.baseTextDistance,l=a.options,u=1.2,p=o*u;isNaN(i.startAngle)&&(i.startAngle=0),isNaN(i.endAngle)&&(i.endAngle=0);var h=i.startAngle,c=i.endAngle,d=(h+c)/2,g=Math.sin(d),f=Math.cos(d),m=f*(s+p)*-1,v=g*(s+p),A=!1;try{r.getBBox()}catch(L){A=!0}if(A===!0)return"translate("+v+","+m+")";var y=r.getBBox().width/2,D=r.getBBox().height/2;v-=y+-1*g*y,m+=D+-1*f*D;var x=Math.max(i.startAngle,i.endAngle),w=Math.min(i.startAngle,i.endAngle),N=x-w;return(.2>N&&r.getBBox().width>24||.05>N)&&!l.plotOptions.pie.isComparative?t.select(r).style("visibility","hidden"):t.select(r).style("visibility",null),"translate("+v+","+m+")"},manipulateDataForMultidimensionalCalloutLegend:function(t){var i=this,e=t.slice();return e=e.map(function(t){return i.arcHelpers.pie(t.data)}),e[0].forEach(function(i,n){var a=0,r=0;e.forEach(function(t){a+=t[n].startAngle,r+=t[n].endAngle}),a/=t.length,r/=t.length,i.startAngle=a,i.endAngle=r,i.i=n}),e[0]},figureOutComparisonLinesData:function(t){var i=this.data,e=this.arcHelpers,n=i.map(function(t){return e.pie(t.data)});return t=t.map(function(t,i){return t.data=[],n.forEach(function(e){t.data.push(e[i])}),t})},comparisonLineResult:function(t,i){var e=i.radius,n=i.baseTextDistance,a=(i.distanceScale,i.pieLayers),r=t.startAngle,s=t.endAngle,o=(r+s)/2,l=Math.sin(o),u=Math.cos(o),p=u*(e+n)*-1,h=l*(e+n),c="";return t.data.forEach(function(t,e){var n=a[e].radius-(a[e].radius-a[e].innerRadius)/2,r=i.getCalcPos(t,n);c+=" M"+h+","+p,c+=" L"+r.x+","+r.y}),c},getCalcPos:function(t,i){var e=(t.startAngle+t.endAngle)/2,n={x:Math.sin(e)*i,y:Math.cos(e)*i*-1};return n},comparisonLineTween:function(i,e){var n=this,a=t.interpolate(e._current,i);return e._current=a(0),function(t){return n.comparisonLineResult(a(t),n)}},updateComparisonLines:function(t){var i=this.options,e=this;t.attr("class","comparisonLine update").transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attrTween("d",function(t){return e.comparisonLineTween(t,this)})},createComparisonLines:function(t){var i=this.options,e=this;t.enter().append("path").style("stroke-width",i.theme.plotOptions.pie.comparisonCallouts.strokeWidth).attr("fill","transparent").attr("stroke",i.theme.plotOptions.pie.comparisonCallouts.fill).attr("class","comparisonLine enter").each(function(t){this._current=t}).attr("d",function(t){return e.comparisonLineResult(t,e)}),t.exit().remove()},createComparisonDotSelection:function(t){var i=this,e=this.calloutLegendWrapper.selectAll(".comparisonDotGroup").data(t);return e.enter().append("g").attr("class","comparisonDotGroup"),e.exit().remove(),e.selectAll(".comparisonDot").data(function(t){return i.arcHelpers.pie(t.data)})},updateComparisonDots:function(t){var i=this.options,e=this;t.each(function(t){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0)}).transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attrTween("transform",function(t){return e.comparisonDotTween(t,this)})},createComparisonDots:function(t){var i=this.options,e=this;t.enter().append("circle").attr("class","comparisonDot").attr("fill",i.theme.plotOptions.pie.comparisonCallouts.fill).attr("r",i.theme.plotOptions.pie.comparisonCallouts.radius).each(function(t,i,e){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0),t.group=e,this._current=t}).attr("transform",function(t){return e.comparisonDotPosition(t,e)}).transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attrTween("transform",function(t){return e.comparisonDotTween(t,this)}),t.exit().remove()},comparisonDotTween:function(i,e){var n=this;isNaN(e._current.endAngle)&&(e._current.endAngle=0,e._current.startAngle=0,i.endAngle=0,i.startAngle=0);var a=t.interpolate(e._current,i);return e._current=a(0),function(t){return n.comparisonDotPosition(a(t),n)}},comparisonDotPosition:function(t,i){var e=i.pieLayers,n=e[t.group].radius-(e[t.group].radius-e[t.group].innerRadius)/2,a=(t.startAngle+t.endAngle)/2,r={x:Math.sin(a)*n,y:Math.cos(a)*n*-1};return"translate("+r.x+","+r.y+")"},createDividingLinesSelection:function(t){var i=this.arcHelpers;this.pieWrapper.append("g");var e=2===this.dataDimensions?[t]:t,n=this.pieWrapper.selectAll(".dividingLineGroup").data(e);return n.enter().append("g").attr("class","dividingLineGroup"),n.exit().remove(),n.selectAll(".dividingLine").data(function(t){return i.pie(t.data?t.data:t)})},updateDividingLines:function(t){var i=this.options,e=this;t.each(function(t){isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0)}).transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attrTween("d",function(t,i,n){return e.dividingLineTween(t,i,n,this,e)})},createDividingLines:function(t){var i=this.options,e=this.divingLinesStyle,n=this;i.theme.plotOptions.pie.stroke!==!1&&((i.theme.plotOptions.pie.stroke.width||0===i.theme.plotOptions.pie.stroke.width)&&(e.width=i.theme.plotOptions.pie.stroke.width),i.theme.plotOptions.pie.stroke.color&&(e.color=i.theme.plotOptions.pie.stroke.color)),t.enter().append("path").each(function(t,i,e){t.group=e,this._current=t}).style("stroke-width",e.width).attr("class","dividingLine").attr("stroke",e.color).attr("d",function(t,i,e){return n.dividingLineResult(t,i,e,this,n)}),t.exit().remove()},dividingLineResult:function(t,i,e,n,a){var r=a.pieLayers;isNaN(t.startAngle)&&(t.startAngle=0),isNaN(t.endAngle)&&(t.endAngle=0);var s=Math.sin(t.startAngle)*r[t.group].innerRadius,o=Math.cos(t.startAngle)*r[t.group].innerRadius*-1,l=Math.sin(t.startAngle)*r[t.group].radius,u=Math.cos(t.startAngle)*r[t.group].radius*-1,p=" M"+s+","+o+" L"+s+","+o+" L"+l+","+u;return p},dividingLineTween:function(i,e,n,a,r){isNaN(a._current.endAngle)&&(a._current.endAngle=0,a._current.startAngle=0,i.endAngle=0,i.startAngle=0);var s=t.interpolate(a._current,i);return a._current=s(0),function(t){return r.dividingLineResult(s(t),e,n,a,r)}},PieLayer:function(i,e,n){e||(e={}),e=n.objectMerger({radius:n.radius,innerRadius:n.innerRadius,opacity:1},e),this.opacity=e.opacity,this.data=i,this.radius=e.radius,this.innerRadius=e.innerRadius,this.wrapper=n.pieWrapper.append("g"),this.updateArcHelper=function(){this.arcHelper=n.useCallouts===!0&&2===n.dataDimensions?n.arcHelpers.calloutArc:t.svg.arc().outerRadius(this.radius).innerRadius(this.innerRadius)},this.updateArcHelper()},getTooltipContent:function(t){var i="function"==typeof this.options.tooltip.format?this.options.tooltip.format:function(t){return t.label+" : "+t.value.toString()};return i.call(this,this.cleanEventData(t))},cleanEventData:function(t){var i={};return Object.defineProperties(i,{label:{value:t.data.label},value:{value:t.data.value}}),void 0!==t.data.parentLabel&&Object.defineProperty(i,"parentLabel",{value:t.data.parentLabel}),i}})});