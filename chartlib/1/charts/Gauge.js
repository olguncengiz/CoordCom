/* Copyright (c) Ericsson 2016 */

define("chartlib/charts/Gauge",["chartlib/charts/Chart","chartlib/base/d3"],function(t,e){"use strict";function a(t,a,i,r,n){var s=this.getChartSize(),l=Math.min(s.width,s.height)/2,h=function(t){return 1>=t?l*t:t},o=e.svg.arc().innerRadius(h(void 0!==i?i:this.options.chart.radius.reference.inner)).outerRadius(h(void 0!==r?r:this.options.chart.radius.reference.outer));return void 0!==n&&o.cornerRadius(h(n)),void 0!==t&&o.startAngle(t),void 0!==a&&o.endAngle(a),o}function i(t,e){var a=e.chart.min,i=e.chart.origin,r=i>a?n*i:l,h=e.chart.max-a;return r+(0!==t?2*s/h*t:0)}function r(t,e){return t.append("foreignObject").attr("class",e.class).append("xhtml:p").attr("class",e.labelClass).style(e.styles).text(e.text)}var n=2*Math.PI,s=2.2,l=n-s,h=n+s;return t.extend({defaults:{theme:{line:{reference:{fill:"#efefef"},valueLine:{fill:"#00a9d4"}},titleText:{styles:{margin:"0",color:"#888888","font-weight":"normal","word-wrap":"break-word","text-align":"center"},heightTransform:30},centerText:{styles:{fill:"#333333","font-weight":"normal","font-family":"EricssonCapitalTT"}},labelText:{styles:{fill:"#58585b","font-weight":"normal"}}},chart:{min:0,origin:0,max:100,labels:{min:"0",max:"100"},areas:[],radius:{reference:{inner:.85,outer:1},valueLine:{inner:.8,outer:.9}}},legend:!1,grid:!1},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.data={},this.value=0,this.gaugeWrapper=[],this.arcHelpers={}},redraw:function(){this.createWrapper(),this.update(this.options.data)},createWrapper:function(){0===this.gaugeWrapper.length&&(this.gaugeWrapper=this.svg.append("g").attr("id","gaugeWrapper-"+this.id))},positionGauge:function(){var t=this.chartSize.margins.left+this.chartSize.width/2,e=this.chartSize.margins.top+this.chartSize.height/2;this.gaugeWrapper.attr("transform","translate("+t+","+e+")")},onUpdate:function(t){this.options.data=t;var e=this.options,a=this.chartSize,i=this.getSize(),r=Math.min(i.width,i.height);this.data=t,this.newValue=Math.round(t.value),a.width=r-e.chart.margin.left-e.chart.margin.right,a.height=r-e.chart.margin.top-e.chart.margin.bottom,a.margins={left:e.chart.margin.left,top:e.chart.margin.top},this.positionGauge(),this.createReferenceLine(),this.createAreas(),this.updateValueLine(),this.updateMiddleText(),this.updateTitleText(),this.updateMinMaxText(),this.value=this.newValue},createReferenceLine:function(){void 0===this.gaugeRefLine&&(this.gaugeRefLine=this.gaugeWrapper.append("g").attr("class","gaugeRefLineGroup").append("path").attr("class","gaugeRefLine").attr("fill",this.options.theme.line.reference.fill)),this.gaugeRefLine.attr("d",a.call(this,l,h))},createAreas:function(){var t=this.options.chart;void 0===this.gaugeAreasGroup&&(this.gaugeAreasGroup=this.gaugeWrapper.append("g").attr("class","gaugeAreasGroup")),t.areas.reduce(function(e,a){return void 0===e?a:(e.fromValue=void 0!==e.fromValue?e.fromValue:t.min,e.toValue=void 0!==e.toValue?e.toValue:a.fromValue,a.fromValue=void 0!==a.fromValue?a.fromValue:e.toValue,a)},void 0);var e=this.options.theme.line.reference.fill,r=this.gaugeAreasGroup.selectAll("g.gaugeAreaGroup").data(t.areas),n=a.call(this),s={chart:t};this.areas=t.areas,r.enter().append("g").attr("class","gaugeAreaGroup").append("path").attr("fill",function(t){return t.fill||e}),r.exit().remove(),r.selectAll("g.gaugeAreaGroup path").attr("d",function(e){return n.startAngle(i(e.fromValue||t.min,s)).endAngle(i(e.toValue||t.max,s)),n()})},updateValueLine:function(){var t=this.options,r=t.animation,n=t.chart.radius.valueLine,s={chart:t.chart},l=function(t){return i(t.previous,s)},h=function(e){return Math.min(t.chart.max,Math.max(t.chart.min,e))},o=h(this.value),u=h(this.newValue),g=a.call(this,i(t.chart.origin,s),l,n.inner,n.outer,n.outer-n.inner),p=function(t){var a=e.interpolate(t.previous,u);return function(e){return t.previous=a(e),g(t)}},c=t.theme.line.valueLine.fill,f=c,d=this.areas;void 0===this.gaugeValueLine&&(this.gaugeValueLine=this.gaugeWrapper.append("g").attr("class","gaugeValueLineGroup").append("path").datum({previous:o}).attr("class","gaugeValueLine").attr("fill",c)),d.some(function(t,e){return u>=t.fromValue&&(void 0===t.toValue||u<t.toValue)?(f=t.lineFill||c,void 0!==d[e+1]&&d[e+1].fromValue>u):void(f=c)}),o===u?this.gaugeValueLine.attr("d",g):this.gaugeValueLine.transition().delay(r.transitionDelay).ease(r.easing).duration(r.transitionDuration).attrTween("d",p).attr("fill",f)},updateMiddleText:function(){void 0===this.gaugeCenterText&&(this.gaugeCenterText=this.gaugeWrapper.append("g").attr("class","gaugeCenterTextGroup").append("text").attr("class","gaugeCenterText").attr("text-anchor","middle").style(this.options.theme.centerText.styles));var t=this.options.chart.labels,a=this.options.animation,i=this.getChartSize(),r=this.options.theme.centerText.styles["font-size"],n=void 0!==r?parseInt(r):i.height/4.5,s=this.newValue,l=t.value&&"function"==typeof t.value.format?t.value.format:function(t){return Math.round(parseFloat(t))};this.gaugeCenterText.style({"font-size":n+"px"}),this.gaugeCenterText.transition().duration(a.transitionDuration).delay(a.transitionDelay).ease(a.easing).tween("text",function(){this.textValue=void 0!==this.textValue?this.textValue:this.textContent;var t=e.interpolate(this.textValue,s);return function(e){var a=t(e);this.textValue=a,this.textContent=l(a)}})},updateTitleText:function(){if(void 0===this.gaugeTitleText){var t=this.gaugeWrapper.append("g").attr("class","gaugeTitleTextGroup");r(t,{"class":"gaugeTitleText",labelClass:"gaugeTitleTextLabel",styles:this.options.theme.titleText.styles,text:this.options.chart.labels.title}),this.gaugeTitleText=t.select(".gaugeTitleText").attr("text-anchor","middle")}var e=this.getChartSize(),a=this.options.theme.titleText.styles["font-size"],i=void 0!==a?parseInt(a):e.height/10,n=e.width/2;this.gaugeTitleText.attr("transform","translate("+-n/2+", "+e.height/10+")").attr("width",Math.max(0,e.width/2)).attr("height",Math.max(0,e.height/3)),this.gaugeTitleText.select(".gaugeTitleTextLabel").style({"line-height":i+"px","font-size":i+"px"})},updateMinMaxText:function(){var t=this.options.theme,e=this.getChartSize(),a=this.options.chart,i=e.width/2,r=e.height/2*.8,n=t.labelText.styles["font-size"],s=void 0!==n?parseInt(n):e.height/15;void 0===this.gaugeRefLineTextGroup&&(this.gaugeRefLineTextGroup=this.gaugeWrapper.append("g").attr("class","gaugeRefLineTextGroup"),this.gaugeRefLineTextGroup.append("text").attr("class","gaugeRefLineText-min").style(t.labelText.styles).text(a.labels.min),this.gaugeRefLineTextGroup.append("text").attr("class","gaugeRefLineText-max").attr("text-anchor","end").attr("startOffset","100%").style(t.labelText.styles).text(a.labels.max)),this.gaugeRefLineTextGroup.attr("transform","translate(0,"+r+")"),this.gaugeRefLineTextGroup.select(".gaugeRefLineText-min").attr("x",-i).style({"font-size":s+"px"}),this.gaugeRefLineTextGroup.select(".gaugeRefLineText-max").style({"font-size":s+"px"}).attr("x",i)},getChartSize:function(){return this.chartSize}})});