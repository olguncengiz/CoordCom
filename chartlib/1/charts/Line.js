/* Copyright (c) Ericsson 2016 */

define("chartlib/charts/Line",["chartlib/base/d3","jscore/ext/privateStore","chartlib/charts/Chart"],function(t,a,e){"use strict";function i(t){var a=this.options;t.exit().transition().duration(.5*a.animation.transitionDuration).delay(a.animation.transitionDelay).ease(a.animation.easing).style("opacity",0).remove()}function n(t){return t.map(function(t){return{label:t.label,visible:t.visible,data:t.data?t.data.map(function(t){return{label:void 0!==t.x?t.x:t.label,value:void 0!==t.y?t.y:t.value}}):[]}})}function r(t){var a=this.options,e=this.chartSize,i=this.getSize();e.width=i.width-a.chart.margin.left-a.chart.margin.right,e.height=i.height-a.chart.margin.top-a.chart.margin.bottom,e.margins={left:a.chart.margin.left,top:a.chart.margin.top},e=this.changeSizeForGrid(e,t),e=this.changeSizeForTitle(e),e=this.changeSizeForLegend(e,t)}function l(t,a){var e=this.options,n=this.shapeHelper,r=this.colorScale;if("area"===e.plotOptions.line.chartType&&(a.enter().append("path").attr("class","enter area").attr("stroke-width","0").attr("fill",function(t){return r(t.label,t)}).attr("fill-opacity",e.theme.plotOptions.line.fillOpacity).attr("d",function(t){return n.area(t.data)}),i.call(this,a)),t.enter().append("path").attr("class","enter line").attr("fill","none").attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("d",function(t){return n.line(t.data)}).attr("stroke",function(t){return e.theme.plotOptions.line.areaLines&&"area"===e.plotOptions.line.chartType?e.theme.plotOptions.line.areaLines.color:r(t.label,t)}).attr("stroke-width",function(){return e.theme.plotOptions.line.areaLines&&"area"===e.plotOptions.line.chartType?e.theme.plotOptions.line.areaLines.width:e.theme.plotOptions.line.lineWidth}),i.call(this,t),e.theme.plotOptions.line.dashArray){var l=e.theme.plotOptions.line.dashArray;t.attr("stroke-dasharray",function(t,a,e){return Array.isArray(l)?l[e]:l(t.label,t,e)})}}function s(t){t.enter().append("circle").attr("class","trackerDot hoverable datapoint").attr("fill","none").attr("r",5).style({cursor:"pointer"}),t.exit().remove()}function o(t){var a=this.options,e=this.colorScale;t.transition().duration(a.animation.transitionDuration).delay(a.animation.transitionDelay).ease(a.animation.easing).attr("fill",function(t){return e(t.label,t)}).style({display:"none"})}function h(){if(this.firstRun){var a=this,e=function(e){return function(){var i=t.mouse(this),n={x:i[0],y:i[1]};a.trigger(e,{coordinate:n,value:{x:p.call(a,n),y:d.call(a,n)}})}};D(this).mouseTrackingRect.on("mousemove",e("chart:mousemove")),this.lineWrapper.on("click",e("chart:click")).on("mouseleave",function(){a.trigger("chart:mouseleave")})}D(this).mouseTrackingRect.attr("width",Math.max(0,this.chartSize.width)).attr("height",Math.max(0,this.chartSize.height))}function c(){var t=this.options,a=t.tooltip.interpolate===!0,e=this.lineWrapper,i=this;void 0===this.mouseMoveEvtId&&(this.mouseMoveEvtId=i.addEventHandler("chart:mousemove",function(t){var n=t.coordinate;e.selectAll("circle.trackerDot").attr("cx",function(t){if(a)return n.x;var e=f.call(i,n,t);return i.scaleHelper.x(e.label)}).attr("cy",function(t,e){if(a){if(void 0===i.pathLinesSelection[0][e])return;var r=y.call(i,n,t,i.pathLinesSelection[0][e]);return void 0!==r?r.y:0}var l=f.call(i,n,t),s=i.defaults.theme.plotOptions.line.lineWidth;return i.scaleHelper.y(l.value)-(5-s)/2}).style("opacity",1).style("display",function(t){if(void 0===t.data[0])return"none";var a=t.data,e=p.call(i,n),r=e>=a[0].label&&e<=a[a.length-1].label;return r?"block":"none"})}),this.mouseLeaveEvtId=i.addEventHandler("chart:mouseleave",function(){e.selectAll("circle.trackerDot").transition().duration(.5*t.animation.transitionDuration).delay(t.animation.transitionDelay).ease(t.animation.easing).style("opacity",0)}))}function p(t){return u.call(this,"x",t)}function d(t){return u.call(this,"y",t)}function u(t,a){var e=this.options.plotOptions.scaleType[t],i=a[t],n=this.scaleHelper[t];if("ordinal"===e){for(var r=n.range(),l=0;i>r[l];)l++;if(0!==l){var s=r[l]-r[l-1],o=i-r[l-1];l=s/2>o?l-1:l}return n.domain()[l]}var h=n.invert(i),c="time"===e;return c?h.getTime():h}function f(t,a){var e=this.options.plotOptions.scaleType.x;if("ordinal"===e){var i,n=p.call(this,t);return a.data.some(function(t){return i=t,t.label===n}),i}return m(p.call(this,t),a.data)}function y(t,a,e){if(void 0!==a.data[0])for(var i,n,r,l=this.scaleHelper.x(a.data[0].label),s=t.x-l,o=s,h=e.getTotalLength();;){if(i=Math.floor((o+h)/2),n=e.getPointAtLength(i),r=n.x+(-l||0),i===h||i===o)return n;if(r>s)h=i;else{if(!(s>r))return n;o=i}}}function m(t,a){if(2===a.length){var e=a[0].label,i=a[1].label,n=i-e,r=t-e;return n/2>r?a[0]:a[1]}var l=Math.floor(a.length/2),s=a[l];return s.label===t?s:m(t,t<s.label?a.slice(0,l+1):a.slice(l))}function g(t){var a=void 0!==this.grid?this.grid.getEntriesAxisFormat():void 0,e="time"===this.options.plotOptions.scaleType.x,i=void 0!==a?a(e?new Date(t.x):t.x):t.x,n=Math.round(100*t.y)/100;return i+" : "+n}function v(t){void 0!==t.line&&(x.call(this,t.line,"line"),D(this).references.line=t.line),void 0!==t.area&&(x.call(this,t.area,"area"),D(this).references.area=t.area)}function x(a,e){var n=this.options,r=this.scaleHelper,l="line"===e,s=e+"Reference",o=D(this).referenceGroups[e],h=o.selectAll("."+s).data(a),c=this.xMin,p=this.xMax,d=this.yMin,u=this.yMax;h.enter().append(l?"line":"rect").attr("class",s),i.call(this,h),h.each(function(a){var e={};if(void 0!==a.x||void 0!==a.y)e={x1:r.x(void 0!==a.x?a.x:c),y1:r.y(void 0!==a.y?a.y:d),x2:r.x(void 0!==a.x?a.x:p),y2:r.y(void 0!==a.y?a.y:u)};else if(void 0!==a.x1||void 0!==a.y1){var i=void 0!==a.y1?Math.min(a.y1,a.y2):void 0,l=void 0!==a.y2?Math.min(Math.max(a.y1,a.y2),u):void 0,s=r.x(void 0!==a.x1?a.x1:c),o=r.y(void 0!==a.y1?a.y1:d),h=void 0!==a.x1?r.x(a.x2)-r.x(a.x1):r.x(p),f=void 0!==i?r.y(i)-r.y(l):r.y(d);e={x:s,y:o-f,width:Math.max(0,h),height:Math.max(0,f)}}a.options&&a.options.transition===!1?t.select(this).attr(a.options).attr(e):t.select(this).attr(a.options).transition().duration(n.animation.transitionDuration).delay(n.animation.transitionDelay).ease(n.animation.easing).attr(e)})}function b(){void 0===D(this).referenceEvtId&&(D(this).referenceEvtId=this.addEventHandler("reference:change",v.bind(this)))}var D=a.create();return e.extend({defaults:{theme:{plotOptions:{line:{dashArray:!1,fillOpacity:1,datalabels:{fill:"#58585b"},lineWidth:3,areaLines:{color:"#ffffff",width:1}}}},plotOptions:{line:{interpolateMode:"linear",chartType:"line",orderDataBySum:!1,datalabels:!1,references:[]},area:{references:[]},scaleType:{x:"ordinal",y:"linear"}}},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.data=[],this.unsortedData=[],this.yMax=0,this.yMin=0,this.storedData=null,this.shapeHelper={},this.lineWrapper=[],this.dataLabelWrapper=[],this.lineWrapperClipPath=[],this.dataPadded=!1,this.wasPadded=!1,this.dataLabelsChanged=!1,this.dataLabelsChangedTimes=0},redraw:function(){this.createWrapper(),this.update(this.options.data)},createWrapper:function(){0===this.lineWrapper.length&&(this.lineWrapperClipPath=this.defs.append("clipPath"),this.lineWrapperClipPath.attr("id","lineChartWrapperClipPath-"+this.id).append("rect"),this.lineWrapper=this.svg.append("g").attr("id","lineWrapper-"+this.id),this.lineWrapper.attr("clip-path","url(#lineChartWrapperClipPath-"+this.id+")"),this.dataLabelWrapperClipPath=this.defs.append("clipPath"),this.dataLabelWrapperClipPath.attr("id","dataLabelWrapperClipPath-"+this.id).append("rect"),this.dataLabelWrapper=this.svg.append("g").attr("id","dataLabelWrapper-"+this.id),this.dataLabelWrapper.attr("clip-path","url(#dataLabelWrapperClipPath-"+this.id+")"),D(this).dataPathGroup=this.lineWrapper.append("g").attr("class","dataPathGroup"),D(this).referenceGroup=this.lineWrapper.append("g").attr("class","referenceGroup"),D(this).referenceGroups={area:D(this).referenceGroup.append("g").attr("class","areaReferenceGroup"),line:D(this).referenceGroup.append("g").attr("class","lineReferenceGroup")},D(this).mouseTrackingRect=this.lineWrapper.append("rect").attr("class","mousetracker").style("opacity",0).attr("x",0).attr("y",0))},onUpdate:function(t){this.options.data=t,t=n(t),this.data=this.addIDsToData(t);var a=this.data,e=this.options,p=this.chartSize,d=this.lineWrapper,u=this.lineWrapperClipPath,f=this.dataLabelWrapper,y=this.dataLabelWrapperClipPath,m=this.colorScale,g=e.plotOptions.line.datalabels===!0;a=a.filter(function(t){return t.visible!==!1}),this.sortDataOnSum(),this.getMaxValues(a),r.call(this,this.data);var x=e.grid?this.grid.getOptions().gridPadding:{left:0,right:0},L=p.margins.left+x.left;d.attr("transform","translate("+L+","+p.margins.top+")"),f.attr("transform","translate("+L+","+p.margins.top+")"),u.selectAll("rect").attr("y",-20).attr("x",-6).attr("width",Math.max(0,p.width-(x.left+x.right)+12)).attr("height",Math.max(0,p.height+20)),y.selectAll("rect").attr("y",-20).attr("x",-x.left).attr("width",Math.max(0,p.width)).attr("height",Math.max(0,p.height+20)),this.setScaleType(),this.createShapeHelpers();var O=D(this).dataPathGroup.selectAll("g.lineGroup").data(a);O.enter().append("g").attr("class","lineGroup"),i.call(this,O);var M,S,A,W=function(t){return[t]},T=O.selectAll("path.area").data(W),P=O.selectAll("path.line").data(W);if(g&&(A=f.selectAll("g.dataLabelObject").data(a),A.enter().append("g").attr("class","dataLabelObject"),i.call(this,A),M=A.selectAll(".dataLabelDot").data(function(t){return t.data=t.data.map(function(a){return a.fill=m(t.label,t),a}),t.data}),S=A.selectAll(".dataLabelText").data(function(t){return t.data})),this.dataLabelsChanged===!0){x=e.grid?this.grid.getOptions().gridPadding:{left:0,right:0};var C=p.width-x.left-x.right;C/=a[0].data.length-2,this.updateLabelChangedLineAndArea(P,T,C),g&&this.updateLabelChangedDataLabels(M,S,C)}else this.dataPadded===!0&&(this.updateInstantlyOnNewDataLineAndArea(P,T),g&&this.updateInstantlyOnNewDataDataLabels(M,S),this.dataPadded=!1,this.wasPadded=!0,this.setScaleType(),this.createShapeHelpers()),this.regularUpdateLineAndArea(P,T),g&&this.regularUpdateDataLabels(M,S);if(l.call(this,P,T),this.pathLinesSelection=D(this).dataPathGroup.selectAll("path.line"),void 0===D(this).references&&(D(this).references={line:0!==e.plotOptions.line.references.length?e.plotOptions.line.references:void 0,area:0!==e.plotOptions.area.references.length?e.plotOptions.area.references:void 0}),v.call(this,D(this).references),h.call(this),b.call(this),this.options.tooltip){var w,H=d.selectAll("g.trackerDotGroup");if(H.empty())H=d.append("g").attr("class","trackerDotGroup");else{var k=H.remove();this.lineWrapper.node().appendChild(k.node())}w=H.selectAll("circle.trackerDot").data(a),s.call(this,w),o.call(this,w),c.call(this)}g&&this.createDataLabels(M,S),this.options.grid&&this.grid.update(t,this.chartSize,this.scaleHelper),this.options.legend!==!1&&this.legend.update(this.unsortedData,this.chartSize,this.scaleHelper)},updateInstantlyOnNewDataLineAndArea:function(t,a){var e=this.shapeHelper,i=this.options;t.attr("class","update line").attr("d",function(t){return e.line(t.data)}),"area"===i.plotOptions.line.chartType&&a.attr("class","update area").attr("d",function(t){return e.area(t.data)})},updateInstantlyOnNewDataDataLabels:function(t,a){var e=this.scaleHelper;t.attr("class","update dataLabelDot").attr("cx",function(t){return e.x(t.label)}).attr("cy",function(t){return e.y(t.value)}),a.attr("class","update dataLabelText").attr("y",function(t){return e.y(t.value)-5}).attr("x",function(t){return e.x(t.label)})},regularUpdateLineAndArea:function(t,a){var e=this.options,i=this.shapeHelper,n=this.colorScale;t.attr("class","update line").transition().duration(e.animation.transitionDuration).delay(e.animation.transitionDelay).ease(e.animation.easing).attr("d",function(t){return i.line(t.data)}).attr("stroke",function(t){return e.theme.plotOptions.line.areaLines&&"area"===e.plotOptions.line.chartType?e.theme.plotOptions.line.areaLines.color:n(t.label,t)}),"area"===e.plotOptions.line.chartType&&a.attr("class","update area").transition().duration(e.animation.transitionDuration).delay(e.animation.transitionDelay).ease(e.animation.easing).attr("d",function(t){return i.area(t.data)}).attr("fill",function(t){return n(t.label,t)})},regularUpdateDataLabels:function(a,e){var i=this.options,n=this.scaleHelper,r=this;a.attr("class","update dataLabelDot").transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attr("cx",function(t){return n.x(t.label)}).attr("cy",function(t){return n.y(t.value)}).attr("fill",function(t){return t.fill}),e.attr("class","update dataLabelText").transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attr("y",function(t){return n.y(t.value)-5}).attr("x",function(t){return n.x(t.label)}).tween("text",function(a){var e=t.interpolate(this.textContent.replace(",","."),a.value);return function(t){this.textContent=r.roundToDecimals(e(t),i.chart.decimals)}})},updateLabelChangedLineAndArea:function(t,a){var e=this.shapeHelper,i=this.options;t.attr("class","update line").transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).style("opacity",1).attr("d",function(t){return e.line(t.data)}).attr("transform","translate(0, 0)"),"area"===i.plotOptions.line.chartType&&a.attr("class","update area").transition().duration(i.animation.transitionDuration).delay(i.animation.transitionDelay).ease(i.animation.easing).attr("d",function(t){return e.area(t.data)})},updateLabelChangedDataLabels:function(a,e){var i=this.scaleHelper,n=this.options;a.attr("class","update dataLabelDot").style("opacity",1).transition().duration(n.animation.transitionDuration).delay(n.animation.transitionDelay).ease(n.animation.easing).attr("cx",function(t){return i.x(t.label)}).attr("cy",function(t){return i.y(t.value)}).attr("transform","translate(0, 0)").style("opacity",function(t,a){return 0===a?0:1}),e.attr("class","update dataLabelText").transition().duration(n.animation.transitionDuration).delay(n.animation.transitionDelay).ease(n.animation.easing).attr("y",function(t){return i.y(t.value)-5}).attr("x",function(t){return i.x(t.label)}).style("opacity",1).attr("transform","translate(0, 0)").style("opacity",function(t,a){return 0===a?0:1}).tween("text",function(a){var e=t.interpolate(this.textContent,a.value);return function(t){this.textContent=Math.round(e(t))}})},setScaleType:function(){var a,e=this.options,i=this.scaleHelper,n=e.grid?this.grid.getOptions().gridPadding:{left:0,right:0},r=this.chartSize.width-(n.left+n.right),l=e.plotOptions.scaleType.x;this.dataPadded===!0&&(r-=r/(this.storedData[0].data.length-1)),this.dataLabelsChanged===!0&&(r-=r/(this.data[0].data.length-2)),"ordinal"===l?a=t.scale.ordinal().rangePoints([0,r]).domain(this.getLabelDomain()):(a="time"===l?t.time.scale():t.scale.linear(),a.domain([this.xMin,this.xMax]).range([0,r])),i.x=a;var s=this.yMin,o=this.yMax;s===o&&(s-=5,o+=5),i.y=t.scale.linear().domain([s,o]).range([this.chartSize.height,0]).nice()},createDataLabels:function(t,a){var e=this.scaleHelper,n=this.options,r=this.dataLabelsChanged,l=this.wasPadded,s=this.chartSize,o=this.data,h=this.dataLabelWrapper;if(t.enter().append("circle").attr("r",3).attr("class","enter dataLabelDot").attr("fill",function(t){return t.fill}).attr("cx",function(t){return e.x(t.label)}).attr("cy",function(t){return e.y(t.value)}),a.enter().append("text").attr("class","enter dataLabelText").attr("text-anchor","middle").attr("x",function(t){return e.x(t.label)}).attr("y",function(t){return e.y(t.value)-5}).attr("fill",n.theme.plotOptions.line.datalabels.fill).text(function(t){return this.roundToDecimals(t.value,n.chart.decimals)}.bind(this)),r===!0){var c=n.grid?this.grid.getOptions().gridPadding:{left:0,right:0},p=(s.width-c.left-c.right)/(o[0].data.length-2);h.selectAll(".enter").attr("transform","translate("+p+", 0)").style("opacity",0).transition().duration(n.animation.transitionDuration).delay(n.animation.transitionDelay).ease(n.animation.easing).attr("transform","translate(0, 0)").style("opacity",1)}l===!0&&h.selectAll(".enter").attr("opacity",0).transition().duration(n.animation.transitionDuration).delay(n.animation.transitionDelay).ease(n.animation.easing).attr("opacity",1),i.call(this,a),i.call(this,t)},sortDataOnSum:function(){var a=this.options,e=this.data;this.unsortedData=JSON.parse(JSON.stringify(e)),a.plotOptions.line.orderDataBySum===!0&&(e.forEach(function(a){a.sum=t.sum(a.data,function(t){return t.value})}),e.sort(function(t,a){return a.sum-t.sum}))},getMaxValues:function(a){var e=this.options,i=e.chart;i.scale.x?(this.xMin=i.scale.x.min,this.xMax=i.scale.x.max):(this.xMin=t.min(a,function(a){return t.min(a.data.map(function(t){return t.label}))}),this.xMax=t.max(a,function(a){return t.max(a.data.map(function(t){return t.label}))})),i.scale.y?(this.yMin=i.zeroBaseline.y?0:i.scale.y.min,this.yMax=i.scale.y.max):(this.yMin=i.zeroBaseline.y?0:t.min(a,function(a){return t.min(a.data.map(function(t){return t.value}))}),this.yMax=t.max(a,function(a){return t.max(a.data.map(function(t){return t.value}))}),0===this.yMax&&0===this.yMin&&(this.yMax=5))},getLabelDomain:function(){var t=[];return this.data.forEach(function(a){t=t.concat(t,a.data.map(function(t){return t.label}))}),t.filter(function(t,a,e){return e.indexOf(t)===a})},createShapeHelpers:function(){var a=this.scaleHelper,e=this.shapeHelper,i=this.options,n=this.chartSize;e.line=t.svg.line().interpolate(i.plotOptions.line.interpolateMode).x(function(t){return a.x(t.label)}).y(function(t){return a.y(t.value)}),e.area=t.svg.area().interpolate(i.plotOptions.line.interpolateMode).x(function(t){return a.x(t.label)}).y0(n.height).y1(function(t){return a.y(t.value)})},getTooltipContent:function(t,a){var e,i=this.options.grid?this.grid.getOptions().gridPadding:{left:0,right:0},n=this.options.tooltip,r=this.chartSize.margins.left+i.left,l="function"==typeof n.format?n.format:g,s={x:a[0]-r,y:a[1]};if(n.interpolate!==!0)e=f.call(this,s,t),e={x:e.label,y:e.value};else{var o,h=-1;this.data.some(function(a){return a.visible!==!1&&h++,t.label===a.label}),o=y.call(this,s,t,this.pathLinesSelection[0][h]),e={x:p.call(this,o),y:d.call(this,o)}}return l.call(this,e)},getValuesAtX:function(t,a){return this.data.map(function(e,i){var n,r={x:this.scaleHelper.x(t)};if(a){var l=y.call(this,r,e,this.pathLinesSelection[0][i]);n={label:p.call(this,l),value:d.call(this,l)}}else n=f.call(this,r,e);return{label:e.label,data:{x:n.label,y:n.value}}}.bind(this))}})});