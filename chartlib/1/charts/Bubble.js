/* Copyright (c) Ericsson 2016 */

define("chartlib/charts/Bubble",["chartlib/base/d3","chartlib/charts/Chart"],function(t,e){"use strict";function a(t){if(this.dataIsGrouped===!0){var e=this.findLabelInGroup(t.label);return this.colorScale(e.label,t)}return this.colorScale(t.label,t)}function i(t){var e,a,i=[],r={};for(e=0;e<t.length;e++)a=t[e].value[3],a&&(void 0===r[a]&&(r[a]={label:a,id:i.length,data:[],visible:t[e].visible},i.push(r[a])),r[a].data.push(t[e]));return 0===Object.keys(r).length?t:(this.dataIsGrouped=!0,i)}return e.extend({defaults:{theme:{plotOptions:{bubble:{border:!1}}},plotOptions:{bubble:{minSize:0,maxSize:"40%",scalePadding:{x:!0,y:!0}},scaleType:{x:"linear",y:"linear"}}},onChartReady:function(){this.attachTo(this.options.element)},createPrivateVariables:function(){this.data=[],this.dataByGroup=[],this.scaleValues={xMax:0,xMin:0,yMax:0,yMin:0,zMin:0,zMax:0,bubbleMinRad:0,bubbleMaxRad:0},this.bubbleWrapperClipPath=[],this.bubbleWrapper=[],this.dataIsGrouped=!1},redraw:function(){this.createWrapper(),this.update(this.options.data)},createWrapper:function(){0===this.bubbleWrapper.length&&(this.bubbleWrapperClipPath=this.defs.append("clipPath"),this.bubbleWrapperClipPath.attr("id","bubbleWrapperClipPath-"+this.id).append("rect"),this.bubbleWrapper=this.svg.append("g").attr("id","bubbleWrapper-"+this.id),this.bubbleWrapper.attr("clip-path","url(#bubbleWrapperClipPath-"+this.id+")"))},onUpdate:function(t){this.options.data=t,this.data=this.addIDsToData(t);var e=this.data,a=this.options,r=this.chartSize,n=this.bubbleWrapper,l=this.bubbleWrapperClipPath;this.dataByGroup=i.call(this,e),e=this.data.filter(function(t){return t.visible!==!1});var s=this.getSize();r.width=s.width-a.chart.margin.left-a.chart.margin.right,r.height=s.height-a.chart.margin.top-a.chart.margin.bottom,r.margins={left:a.chart.margin.left,top:a.chart.margin.top},r=this.changeSizeForTitle(r),r=this.changeSizeForLegend(r,this.dataByGroup),r=this.changeSizeForGrid(r,e);var b={left:0,right:0};a.grid!==!1&&(b=this.grid.getOptions().gridPadding),n.attr("transform","translate("+(r.margins.left+b.left)+","+r.margins.top+")"),l.selectAll("rect").attr("y",0).attr("x",0).attr("width",Math.max(0,r.width-(b.left+b.right))).attr("height",Math.max(0,r.height)),this.setRangesAndSizes(),this.setScaleHelpers(),this.bubbleSelection=n.selectAll(".bubble").data(e),this.updateExistingElements(this.bubbleSelection),this.createElements(this.bubbleSelection),a.theme.plotOptions.bubble.border?this.bubbleSelection.attr("stroke",a.theme.plotOptions.bubble.border.color).attr("stroke-width",a.theme.plotOptions.bubble.border.width):this.bubbleSelection.attr("opacity","0.85"),this.options.grid!==!1&&this.grid.update(e,this.chartSize,this.scaleHelper),this.options.legend!==!1&&this.legend.update(this.dataByGroup,this.chartSize,this.scaleHelper)},setRangesAndSizes:function(){this.setRanges(),this.setBubbleSizes(),this.addRangePadding(),Object.keys(this.scaleValues).forEach(function(t){this.scaleValues[t]=this.roundToDecimals(this.scaleValues[t])}.bind(this))},setRanges:function(){var e=this.options,a=this.scaleValues,i=this.data;e.chart.scale.x?(a.xMax=e.chart.scale.x.max,a.xMin=e.chart.zeroBaseline.x?0:e.chart.scale.x.min):(a.xMax=t.max(i,function(t){return t.value[0]}),a.xMin=t.min(i,function(t){return t.value[0]})),e.chart.scale.y?(a.yMax=e.chart.scale.y.max,a.yMin=e.chart.zeroBaseline.y?0:e.chart.scale.y.min):(a.yMax=t.max(i,function(t){return t.value[1]}),a.yMin=t.min(i,function(t){return t.value[1]})),e.chart.scale.z?(a.zMax=e.chart.scale.z.max,a.zMin=e.chart.scale.z.min):(a.zMax=t.max(i,function(t){return t.value[2]}),a.zMin=0)},setBubbleSizes:function(){var t=this.chartSize,e=this.scaleValues,a=this.options,i=Math.min(t.height,t.width);a.plotOptions.bubble.maxSize&&(-1!==a.plotOptions.bubble.maxSize.toString().indexOf("%")?(e.bubbleMaxRad=i*(parseFloat(a.plotOptions.bubble.maxSize.split("%")[0])/100),e.bubbleMaxRad=e.bubbleMaxRad/2):e.bubbleMaxRad=parseInt(a.plotOptions.bubble.maxSize)),a.plotOptions.bubble.minSize&&(e.bubbleMinRad=-1!==a.plotOptions.bubble.minSize.toString().indexOf("%")?i*(parseFloat(a.plotOptions.bubble.minSize.split("%")[0])/100):parseInt(a.plotOptions.bubble.minSize))},addRangePadding:function(){var t=this.chartSize,e=this.scaleValues,a=this.options;if(a.plotOptions.bubble.scalePadding.x===!0&&!a.chart.scale.x){var i=Math.abs(e.xMax-e.xMin),r=2*e.bubbleMaxRad*(i/t.width);e.xMin-=r,e.xMax+=r}if(a.plotOptions.bubble.scalePadding.y===!0&&!a.chart.scale.y){var n=Math.abs(e.yMax-e.yMin),l=4*e.bubbleMaxRad*(n/t.height);e.yMin-=l,e.yMax+=l}},setScaleHelpers:function(){var e=this.scaleHelper,a=this.scaleValues,i=this.chartSize,r=this.options,n={left:0,right:0};r.grid!==!1&&(n=this.grid.getOptions().gridPadding),e.x=t.scale.linear().domain([a.xMin,a.xMax]).range([0,i.width-n.left-n.right]),e.y=t.scale.linear().domain([a.yMin,a.yMax]).range([i.height,0]),e.r=t.scale.sqrt().domain([a.zMin,a.zMax]).range([a.bubbleMinRad,a.bubbleMaxRad])},findLabelInGroup:function(t){var e,a,i,r,n;for(a=0,i=this.dataByGroup.length;i>a;a++)for(e=this.dataByGroup[a].data,r=0,n=e.length;n>r;r++)if(t===e[r].label)return this.dataByGroup[a]},updateExistingElements:function(){var t=this.options,e=this.scaleHelper;this.bubbleSelection.attr("class","update bubble clickable hoverable datapoint").transition().duration(t.animation.transitionDuration).delay(t.animation.transitionDelay).ease(t.animation.easing).attr("cx",function(t){return e.x(t.value[0])}).attr("cy",function(t){return e.y(t.value[1])}).attr("fill",a.bind(this)).attr("r",function(t){return e.r(t.value[2])})},createElements:function(){var t=this.scaleHelper;this.bubbleSelection.enter().append("circle").attr("class","enter bubble clickable hoverable datapoint").attr("cx",function(e){return t.x(e.value[0])}).attr("cy",function(e){return t.y(e.value[1])}).attr("fill",a.bind(this)).attr("r",function(e){return t.r(e.value[2])}),this.bubbleSelection.exit().remove()},toggleEntryVisibility:function(t){this.dataIsGrouped?this.dataByGroup.some(function(a){var i=a.label===t.label;return i&&a.data.forEach(e.prototype.toggleEntryVisibility.bind(this)),i}.bind(this)):e.prototype.toggleEntryVisibility.call(this,t)},cleanEventData:function(t){var e={};return Object.defineProperties(e,{label:{value:t.label},value:{value:t.value.slice(0)}}),e}})});